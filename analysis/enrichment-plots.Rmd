---
title: "Functional Enrichment Analysis Plots"
author: "Katie Hooker"
date: "2025-02-17"
output: html_document
---


This script is for plotting the outputs of the functional enrichment analysis run on the 97 selected MVP phenotypes.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(ggplot2))
library(stringr)

```

# Plotting function
```{r}
enrichment_plot <- function(data, group, xlim=NULL){
  
  group = sym(group)
  p <- ggplot(data, aes(x = Enrichment, y = !!group))+
    geom_point() +
    xlab("Enrichment") +
    geom_errorbarh(aes(xmin=Enrichment-ci, xmax=Enrichment+ci), height=.2) +
    facet_wrap(Trait_label~.,ncol = 1) +
    theme_bw()  +
    geom_vline(xintercept = 1,linetype="dotted", colour = "red") +
    theme(axis.ticks = element_blank(),
      panel.grid.minor = element_blank(),
      axis.line = element_line(colour = "black"),
      axis.text = element_text(size = 8, colour = "black"),
      axis.title = element_text(face="bold",size = 12),
      strip.text = element_text(face="bold",size = 10),
      panel.spacing.x = unit(0.6,units = "cm"),
      axis.title.y = element_blank(),
      legend.position = "none",
      plot.title = element_text(hjust = 0.5))
  
  if(!is.null(xlim)){
    p <- p + coord_cartesian(xlim = xlim)
  }
  print(p)

}
```

# Compiling all trait results
```{r}
output_path <- "/dartfs/rc/lab/S/Szhao/katieh/organoid-rotation/outputs/"

# Reading in trait abbreviations and their corresponding trait names
pheno_list <- read.csv("/dartfs/rc/lab/S/Szhao/katieh/organoid-rotation/data/MVP_pheno_list.csv")

# Fixing traits that are not unique after shortening
pheno_list[pheno_list$Description == "Irritable Bowel Syndrome (IBS)",]$Description <- "Irritable Bowel Syndrome survey result"
pheno_list[pheno_list$Description == "glucose (finger stick, mean, inv-norm transformed)",]$Description <- "Glucose finger stick result"

pheno_list <- pheno_list %>% 
  mutate(Short_desc = str_trim(gsub("\\(.*?\\)", "", Description))) %>% 
  mutate(Short_desc = str_to_sentence(Short_desc)) %>% 
  mutate(Short_desc = gsub("(?i)Gerd", "GERD", Short_desc)) %>% 
  mutate(Short_desc = gsub("(?i)nos", "NOS", Short_desc))

odd_rows <- seq_len(nrow(pheno_list)) %% 2
pheno_list_unique <- pheno_list[odd_rows==1,]
  
pheno_list_unique$N_desc <- NA

for (trait in pheno_list_unique$Trait){
  if (pheno_list_unique[pheno_list_unique$Trait == trait,]$Category == "Labs") {
    N_string = paste0("N total = ", pheno_list_unique[pheno_list_unique$Trait == trait,]$num_samples.EUR)
  } else {
    N_string = paste0("N cases = ", pheno_list_unique[pheno_list_unique$Trait == trait,]$num_cases.EUR, ", N controls = ", pheno_list_unique[pheno_list_unique$Trait == trait,]$num_controls.EUR)
  }
  pheno_list_unique[pheno_list_unique$Trait == trait,]$N_desc <- N_string
}

pheno_list_unique <- pheno_list_unique %>% mutate(Short_desc = paste0(Short_desc, " (", N_desc, ")"))
traits <- pheno_list_unique$Trait
traitslab <- pheno_list_unique$Short_desc

all_traits <- NULL 
for (i in 1:length(traits)){
  efile1 <- read.table(paste0(output_path, sprintf("results/%s_enrichment.results", traits[i])),
                       header=T)
  enrich <- efile1[1:4,c(1,5,6,7)]
  enrich$ci <- 1.96*enrich$Enrichment_std_error
  enrich$Trait <- traits[i]
  enrich$Trait_label <- traitslab[i]

  if(is.null(all_traits)){
    all_traits <- enrich
  } else{
    all_traits <- rbind(all_traits, enrich)
  }
}
```

# Plot all traits, four at a time
```{r}
for (i in seq(1, nrow(all_traits)-4, 16)){
  enrichment_plot(all_traits[i:(i+15),], group="Category", xlim=c(-120,120))
}
# Last trait
enrichment_plot(all_traits[385:388,], group="Category", xlim=c(-120,120))

```

# Looking at which traits have abnormally large enrichment or large standard error
```{r}
hist(all_traits$Enrichment, breaks = 50)
hist(all_traits$Enrichment_std_error, breaks = 20)
```


```{r}
subset(all_traits, Enrichment < -200)
subset(all_traits, Enrichment > 200)
subset(all_traits, Enrichment_std_error < -200)
subset(all_traits, Enrichment_std_error > 200)

```


